<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Two-Layer Real-Time IPS Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        /* [ Style section is the same as the previous version, omitted for brevity ] */
        body { background-color: #f0f2f5; }
        .dashboard-header { background: linear-gradient(90deg, #0d47a1, #1976d2); color: white; padding: 20px 0; margin-bottom: 30px; }
        .log-box { max-height: 70vh; overflow-y: scroll; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem;}
        .stat-card { text-align: center; }
        .layer-badge { font-weight: bold; padding: 5px 10px; color: white; border-radius: 5px; }
        .layer-1 { background-color: #ff9800; }
        .layer-2 { background-color: #e91e63; }
        .alert-row:hover, .packet-row:hover { background-color: #e9ecef; }
        .content-preview {
            white-space: pre-wrap; word-break: break-all; background-color: #f8f9fa;
            padding: 2px 5px; border-radius: 3px; max-width: 300px;
            overflow: hidden; text-overflow: ellipsis;
        }
    </style>
</head>
<body>

<div class="dashboard-header text-center">
    <h1>ADVANCED INTRUSION PREVENTION SYSTEM</h1>
    <p class="lead">Live Analysis & Demo Test Mode</p>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-dark text-white">Live System Statistics</div>
                <div class="card-body stat-card">
                    <p>Packets Processed: <strong id="total-packets">0</strong></p>
                    <p>Content Threats: <strong id="content-threats">0</strong></p>
                    <p>Behavioral Threats: <strong id="behavior-threats">0</strong></p>
                    <p>IPs Blocklisted: <strong id="blocked-ips">0</strong></p>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-info text-dark">Demo Control</div>
                <div class="card-body d-grid gap-2">
                    <button id="start-test-btn" onclick="startTest()" class="btn btn-success w-100">â–¶ Run Demo Test</button>
                    <button id="stop-test-btn" onclick="stopTest()" class="btn btn-danger w-100" disabled>ðŸ›‘ Stop Test</button>
                    <small class="text-muted">Processes the `test_packets.pcap` file to verify detection.</small>
                    <p class="mb-0 mt-2">Mode: <span id="current-mode" class="badge bg-primary">LIVE SNIFFING</span></p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-lg">
                <div class="card-header bg-dark text-white"><h5 class="mb-0">ðŸ“¡ Live Packet Log</h5></div>
                <div class="card-body log-box p-0" id="processed-packets-container">
                    <p class="text-muted text-center m-3">Listening...</p>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card shadow-lg">
                <div class="card-header bg-dark text-white"><h5 class="mb-0">ðŸš¨ Security Alerts</h5></div>
                <div class="card-body log-box p-0" id="alerts-container">
                    <p class="text-muted text-center m-3">No threats detected yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function updateDashboard() {
        $.getJSON('/data', function(data) {
            // Stats update is the same
            $('#total-packets').text(data.total_packets);
            $('#content-threats').text(data.content_threats);
            $('#behavior-threats').text(data.behavior_threats);
            $('#blocked-ips').text(data.blocked_ips);

            // Mode indicator
            const modeSpan = $('#current-mode');
            if (data.sim_running) {
                modeSpan.text('TEST RUNNING').removeClass('bg-primary').addClass('bg-warning');
                $('#start-test-btn').prop('disabled', true);
                $('#stop-test-btn').prop('disabled', false);
            } else {
                modeSpan.text('LIVE SNIFFING').removeClass('bg-warning').addClass('bg-primary');
                $('#start-test-btn').prop('disabled', false);
                $('#stop-test-btn').prop('disabled', true);
            }
            
            // Log rendering is the same
            const alertsContainer = $('#alerts-container');
            alertsContainer.empty();
            if (data.alerts.length > 0) {
                const table = $('<table class="table table-sm table-borderless mb-0"><thead><tr><th>Layer</th><th>Alert</th><th>Source</th><th>Content</th></tr></thead><tbody></tbody></table>');
                const tbody = table.find('tbody');
                data.alerts.forEach(log => {
                    const row = `<tr class="alert-row"><td><span class="layer-badge layer-${log.layer}">L${log.layer}</span></td><td>${log.alert_type}<br><small>${log.details}</small></td><td>${log.source_ip}</td><td><div class="content-preview" title="${escape(log.content)}">${escape(log.content)}</div></td></tr>`;
                    tbody.append(row);
                });
                alertsContainer.append(table);
            } else { alertsContainer.append('<p class="text-muted text-center m-3">No threats detected.</p>'); }

            const packetsContainer = $('#processed-packets-container');
            packetsContainer.empty();
            if (data.processed_packets.length > 0) {
                const table = $('<table class="table table-sm table-borderless mb-0"><thead><tr><th>Time</th><th>Source â†’ Dest</th><th>Proto</th></tr></thead><tbody></tbody></table>');
                const tbody = table.find('tbody');
                data.processed_packets.forEach(pkt => {
                    const row = `<tr class="packet-row"><td>${pkt.timestamp}</td><td>${pkt.source} â†’ ${pkt.destination}</td><td>${pkt.protocol}</td></tr>`;
                    tbody.append(row);
                });
                packetsContainer.append(table);
            } else { packetsContainer.append('<p class="text-muted text-center m-3">No packets processed in this mode.</p>'); }
        });
    }

    // --- NEW: Functions for the test buttons ---
    function startTest() {
        $.post('/start_test');
    }

    function stopTest() {
        $.post('/stop_test');
    }

    function escape(str) { return $('<div>').text(str).html(); }

    $(document).ready(function() {
        updateDashboard();
        setInterval(updateDashboard, 1500);
    });
</script>
</body>
</html>